<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - EcoRide</title>
    <link href="./styles.css" rel="stylesheet">

</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">üå± EcoRide</a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="covoiturages.html">Covoiturages</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact.html">Contact</a>
                    </li>
                    <li class="nav-item" id="authNav">
                        <a class="nav-link" href="connexion.html">Connexion</a>
                    </li>
                    <li class="nav-item" id="profileNav" style="display: none;">
                        <a class="nav-link active" href="profil.html">Mon Profil</a>
                    </li>
                    <li class="nav-item" id="logoutNav" style="display: none;">
                        <a class="nav-link" href="#" onclick="logout()">D√©connexion</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section Profil -->
    <section class="profile-hero">
        <div class="container">
            <div class="profile-content">
                <!-- Carte utilisateur -->
                <div class="profile-user-card">
                    <div class="profile-avatar">üë§</div>
                    <div class="profile-user-details">
                        <h1 id="profileUserName">Chargement...</h1>
                        <p id="profileUserEmail">email@example.com</p>
                    </div>
                </div>

                <!-- Statistiques -->
                <div class="profile-stats-container">
                    <div class="profile-stat-card">
                        <span class="stat-icon">üí∞</span>
                        <span class="stat-value" id="profileCredits">0</span>
                        <span class="stat-label">Cr√©dits</span>
                    </div>
                    <div class="profile-stat-card">
                        <span class="stat-icon">‚≠ê</span>
                        <span class="stat-value" id="profileRating">4.5</span>
                        <span class="stat-label">Note moyenne</span>
                    </div>
                    <div class="profile-stat-card">
                        <span class="stat-icon">üöó</span>
                        <span class="stat-value" id="profileTotalRides">0</span>
                        <span class="stat-label">Trajets effectu√©s</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contenu principal -->
    <div class="container profile-main">
        <div class="row">
            <!-- Navigation des onglets -->
            <div class="col-lg-3">
                <div class="profile-navigation">
                    <h5>Navigation</h5>
                    <ul class="profile-nav-menu">
                        <li class="profile-nav-item">
                            <a href="#" class="profile-nav-link active" data-target="profile-info">
                                <span class="emoji">üìù</span>Informations personnelles
                            </a>
                        </li>
                        <li class="profile-nav-item">
                            <a href="#" class="profile-nav-link" data-target="my-rides">
                                <span class="emoji">üöó</span>Mes trajets propos√©s
                            </a>
                        </li>
                        <li class="profile-nav-item">
                            <a href="#" class="profile-nav-link" data-target="my-reservations">
                                <span class="emoji">üìÖ</span>Mes r√©servations
                            </a>
                        </li>
                        <li class="profile-nav-item">
                            <a href="#" class="profile-nav-link" data-target="my-vehicles">
                                <span class="emoji">üöô</span>Mes v√©hicules
                            </a>
                        </li>
                        <li class="profile-nav-item">
                            <a href="#" class="profile-nav-link" data-target="account-settings">
                                <span class="emoji">‚öôÔ∏è</span>Param√®tres du compte
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Contenu des onglets -->
            <div class="col-lg-9">
                <div class="profile-tab-content">

                        <!-- Informations personnelles -->
                        <div class="tab-pane active" id="profile-info">

                            <!-- Section Informations de base -->
                            <div class="profile-section">
                                <h5>
                                    Informations de base
                                    <div class="section-actions">
                                        <button class="btn btn-success btn-sm" onclick="editProfile()">Modifier</button>
                                    </div>
                                </h5>

                                <div class="profile-form-container">
                                    <form id="profileForm">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">Pseudo</label>
                                                <input type="text" class="form-control" id="profilePseudo" readonly>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Email</label>
                                                <input type="email" class="form-control" id="profileEmail" readonly>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">Nom complet</label>
                                                <input type="text" class="form-control" id="profileFullName" placeholder="Votre nom complet">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">T√©l√©phone</label>
                                                <input type="tel" class="form-control" id="profilePhone" placeholder="Votre num√©ro">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Adresse</label>
                                            <input type="text" class="form-control" id="profileAddress" placeholder="Votre adresse">
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">Date de naissance</label>
                                                <input type="date" class="form-control" id="profileBirthdate">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Genre</label>
                                                <select class="form-control" id="profileGender">
                                                    <option value="">Choisir...</option>
                                                    <option value="homme">Homme</option>
                                                    <option value="femme">Femme</option>
                                                    <option value="autre">Autre</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Bio</label>
                                            <textarea class="form-control" id="profileBio" rows="3" placeholder="Parlez-nous de vous..."></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-success">
                                            üíæ Enregistrer les modifications
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Section Badges et Statuts -->
                            <div class="profile-section">
                                <h5>Badges et certifications</h5>
                                <div class="d-flex gap-2 flex-wrap">
                                    <span class="eco-badge">üå± √âco-conducteur</span>
                                    <span class="status-badge status-active">‚úÖ Profil v√©rifi√©</span>
                                    <span class="status-badge status-pending">‚è≥ En attente de validation</span>
                                </div>
                            </div>
                        </div>

                        <!-- Mes trajets -->
                        <div class="tab-pane" id="my-rides">
                            <div class="profile-section">
                                <h5>
                                    üöó Mes trajets propos√©s
                                    <div class="section-actions">
                                        <a href="covoiturages.html" class="btn btn-success btn-sm">
                                            ‚ûï Nouveau trajet
                                        </a>
                                    </div>
                                </h5>
                                <div class="profile-form-container">
                                    <div id="myRidesList">
                                        <div class="empty-state">
                                            <div class="empty-icon">üöó</div>
                                            <h6>Aucun trajet propos√©</h6>
                                            <p>Commencez √† partager vos trajets et contribuez √† une mobilit√© plus durable !</p>
                                            <a href="covoiturages.html" class="btn btn-primary">
                                                Proposer mon premier trajet
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mes r√©servations -->
                        <div class="tab-pane" id="my-reservations">
                            <div class="profile-section">
                                <h5>
                                    üìÖ Mes r√©servations
                                    <div class="section-actions">
                                        <a href="covoiturages.html" class="btn btn-success btn-sm">Rechercher un trajet</a>
                                    </div>
                                </h5>
                                <div class="profile-form-container">
                                    <div id="myReservationsList">
                                        <div class="empty-state">
                                            <div class="empty-icon">üìÖ</div>
                                            <h6>Aucune r√©servation</h6>
                                            <p>Vous n'avez pas encore r√©serv√© de trajet. Explorez les covoiturages disponibles !</p>
                                            <a href="covoiturages.html" class="btn btn-primary">
                                                Rechercher un trajet
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mes v√©hicules -->
                        <div class="tab-pane" id="my-vehicles">
                            <div class="profile-section">
                                <h5>
                                    üöô Mes v√©hicules
                                    <div class="section-actions">
                                        <button class="btn btn-success btn-sm" onclick="addVehicle()">
                                            ‚ûï Ajouter un v√©hicule
                                        </button>
                                    </div>
                                </h5>
                                <div class="profile-form-container">
                                    <div id="myVehiclesList">
                                        <div class="empty-state">
                                            <div class="empty-icon">üöô</div>
                                            <h6>Aucun v√©hicule enregistr√©</h6>
                                            <p>Ajoutez vos v√©hicules pour proposer des trajets en covoiturage.</p>
                                            <button class="btn btn-primary" onclick="addVehicle()">
                                                Ajouter mon premier v√©hicule
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Param√®tres du compte -->
                        <div class="tab-pane" id="account-settings">
                            <!-- Section S√©curit√© -->
                            <div class="profile-section">
                                <h5>
                                    üîí S√©curit√©
                                </h5>
                                <div class="profile-form-container">
                                    <div class="settings-row">
                                        <div class="setting-info">
                                            <h6>Mot de passe</h6>
                                            <p class="text-muted">Modifiez votre mot de passe r√©guli√®rement pour s√©curiser votre compte</p>
                                        </div>
                                        <button class="btn btn-outline-primary" onclick="changePassword()">
                                            üîë Changer le mot de passe
                                        </button>
                                    </div>
                                    <div class="settings-row">
                                        <div class="setting-info">
                                            <h6>Authentification √† deux facteurs</h6>
                                            <p class="text-muted">Ajoutez une couche de s√©curit√© suppl√©mentaire √† votre compte</p>
                                        </div>
                                        <button class="btn btn-outline-primary" onclick="twoFactor()">
                                            üì± Configurer 2FA
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Section Gestion du compte -->
                            <div class="profile-section">
                                <h5>
                                    ‚öôÔ∏è Gestion du compte
                                </h5>
                                <div class="profile-form-container">
                                    <div class="alert alert-warning" role="alert">
                                        <strong>‚ö†Ô∏è Zone sensible</strong><br>
                                        Ces actions ont des cons√©quences importantes sur votre compte.
                                    </div>
                                    <div class="settings-row">
                                        <div class="setting-info">
                                            <h6>D√©sactiver temporairement</h6>
                                            <p class="text-muted">Votre profil sera masqu√© mais vos donn√©es seront conserv√©es</p>
                                        </div>
                                        <button class="btn btn-outline-warning" onclick="deactivateAccount()">
                                            ‚è∏Ô∏è D√©sactiver le compte
                                        </button>
                                    </div>
                                    <div class="settings-row">
                                        <div class="setting-info">
                                            <h6 class="text-danger">Suppression d√©finitive</h6>
                                            <p class="text-muted">Cette action est irr√©versible. Toutes vos donn√©es seront perdues.</p>
                                        </div>
                                        <button class="btn btn-outline-danger" onclick="deleteAccount()">
                                            üóëÔ∏è Supprimer d√©finitivement
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth JS -->
    <script src="./auth.js"></script>

    <script>
        // Gestion des onglets
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initialisation de la page profil');

            // Initialiser la navigation
            initNavigation();

            // Initialiser les onglets
            initTabs();

            // Charger les donn√©es du profil
            loadProfileData();
            initProfileForms();
        });

        function initNavigation() {
            console.log('üîó Initialisation de la navigation');

            // Gestion du menu burger
            const navbarToggler = document.querySelector('.navbar-toggler');
            const navbarCollapse = document.querySelector('.navbar-collapse');

            if (navbarToggler && navbarCollapse) {
                navbarToggler.addEventListener('click', function() {
                    navbarCollapse.classList.toggle('show');
                });

                // Fermer le menu quand on clique sur un lien
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        navbarCollapse.classList.remove('show');
                    });
                });
            }

            // Mettre √† jour la navigation selon l'√©tat de connexion
            updateNavigation();
        }

        function updateNavigation() {
            // V√©rifier si l'utilisateur est connect√©
            fetch('/api/auth/session', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                const authNav = document.getElementById('authNav');
                const profileNav = document.getElementById('profileNav');
                const logoutNav = document.getElementById('logoutNav');

                if (data.isLoggedIn) {
                    // Utilisateur connect√©
                    if (authNav) authNav.style.display = 'none';
                    if (profileNav) profileNav.style.display = 'block';
                    if (logoutNav) logoutNav.style.display = 'block';
                } else {
                    // Utilisateur non connect√© - rediriger vers la page de connexion
                    window.location.href = 'connexion.html';
                }
            })
            .catch(error => {
                console.error('Erreur lors de la v√©rification de session:', error);
                // En cas d'erreur, rediriger vers la connexion
                window.location.href = 'connexion.html';
            });
        }

        function initTabs() {
            console.log('üîó Initialisation des onglets');

            const tabLinks = document.querySelectorAll('.profile-nav-link[data-target]');
            const tabPanes = document.querySelectorAll('.tab-pane');

            console.log('üìÑ Onglets trouv√©s:', tabLinks.length);
            console.log('üìÑ Panneaux trouv√©s:', tabPanes.length);

            // Log des √©l√©ments trouv√©s pour debug
            tabLinks.forEach((link, index) => {
                console.log(`Onglet ${index}:`, link.textContent, 'Target:', link.dataset.target);
            });

            tabPanes.forEach((pane, index) => {
                console.log(`Panneau ${index}:`, pane.id, 'Visible:', pane.classList.contains('active'));
            });

            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    const targetId = this.dataset.target;
                    console.log('üñ±Ô∏è Clic sur onglet:', targetId);

                    // Retirer active de tous les liens
                    tabLinks.forEach(l => l.classList.remove('active'));

                    // Retirer active de tous les panneaux
                    tabPanes.forEach(p => {
                        p.classList.remove('active');
                        console.log('‚ùå Panneau d√©sactiv√©:', p.id);
                    });

                    // Activer le lien cliqu√©
                    this.classList.add('active');

                    // Activer le panneau correspondant
                    const targetPane = document.getElementById(targetId);
                    if (targetPane) {
                        targetPane.classList.add('active');
                        console.log('‚úÖ Panneau activ√©:', targetId);
                        console.log('‚úÖ Classes du panneau:', targetPane.className);
                    } else {
                        console.error('‚ùå Panneau non trouv√©:', targetId);
                    }
                });
            });

            console.log('üéâ Initialisation des onglets termin√©e');
        }

        function loadProfileData() {
            console.log('üîÑ D√©but du chargement des donn√©es profil...');

            fetch('/api/auth/profile', {
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('üì° R√©ponse API profile:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üìã Donn√©es re√ßues:', data);

                if (data.success && data.user) {
                    console.log('‚úÖ Utilisateur trouv√©:', data.user.pseudo);

                    // Mise √† jour du header
                    const userNameHeader = document.getElementById('profileUserName');
                    const userEmailHeader = document.getElementById('profileUserEmail');
                    const creditsHeader = document.getElementById('profileCredits');
                    const ratingHeader = document.getElementById('profileRating');
                    const totalRidesHeader = document.getElementById('profileTotalRides');

                    if (userNameHeader) userNameHeader.textContent = data.user.pseudo || 'Utilisateur';
                    if (userEmailHeader) userEmailHeader.textContent = data.user.email || '';
                    if (creditsHeader) creditsHeader.textContent = data.user.credits || '0';
                    if (ratingHeader) ratingHeader.textContent = data.user.rating || '4.5';
                    if (totalRidesHeader) {
                        const totalRides = (data.user.totalRidesAsDriver || 0) + (data.user.totalRidesAsPassenger || 0);
                        totalRidesHeader.textContent = totalRides;
                    }

                    // Remplir les champs du formulaire
                    const fields = {
                        'profilePseudo': data.user.pseudo,
                        'profileEmail': data.user.email,
                        'profileFullName': data.user.fullName,
                        'profilePhone': data.user.phone,
                        'profileAddress': data.user.address,
                        'profileBirthdate': data.user.birthdate,
                        'profileGender': data.user.gender,
                        'profileBio': data.user.bio
                    };

                    Object.entries(fields).forEach(([fieldId, value]) => {
                        const field = document.getElementById(fieldId);
                        if (field && value) {
                            field.value = value;
                            console.log(`‚úÖ ${fieldId} rempli:`, value);
                        }
                    });

                    console.log('üéâ Tous les formulaires remplis avec succ√®s !');
                } else {
                    console.error('‚ùå Erreur dans les donn√©es:', data);
                }
            })
            .catch(error => {
                console.error('üí• Erreur lors du chargement:', error);
            });
        }

        function initProfileForms() {
            // G√©rer la soumission du formulaire profil
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('üíæ Soumission du formulaire profil');
                    // TODO: Impl√©menter la sauvegarde
                    alert('Fonctionnalit√© de sauvegarde en d√©veloppement');
                });
            }
        }

        // Fonctions utilitaires
        function addVehicle() {
            alert('Fonctionnalit√© d\'ajout de v√©hicule en d√©veloppement');
        }

        function changePassword() {
            alert('Fonctionnalit√© de changement de mot de passe en d√©veloppement');
        }

        function twoFactor() {
            alert('Fonctionnalit√© d\'authentification 2FA en d√©veloppement');
        }

        function deactivateAccount() {
            if (confirm('√ätes-vous s√ªr de vouloir d√©sactiver votre compte ?')) {
                alert('Fonctionnalit√© en d√©veloppement');
            }
        }

        function deleteAccount() {
            if (confirm('ATTENTION : Cette action est irr√©versible !\n\n√ätes-vous absolument s√ªr de vouloir supprimer d√©finitivement votre compte ?')) {
                alert('Fonctionnalit√© en d√©veloppement');
            }
        }

        function logout() {
            console.log('üëã D√©connexion en cours...');

            fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ D√©connexion r√©ussie');
                // Rediriger vers la page d'accueil
                window.location.href = 'index.html';
            })
            .catch(error => {
                console.error('‚ùå Erreur lors de la d√©connexion:', error);
                // M√™me en cas d'erreur, on redirige
                window.location.href = 'index.html';
            });
        }
    </script>
</body>
</html>